<div class="page-container">
  <!-- Header -->
  <div class="page-header" [class.fade-in]="fadeIn">
    <h1 class="page-title gradient-text">Mes Tâches & Besoins du Service</h1>
    <p class="page-subtitle">
      Consultez les besoins de votre équipe et suivez l'avancement des validations.
    </p>
  </div>

  <!-- Indicateur de chargement -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Chargement des besoins du service...</p>
  </div>

  <!-- Message si pas d'utilisateur connecté -->
  <div *ngIf="!currentUserId && !isLoading" class="error-container">
    <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="8" x2="12" y2="12"></line>
      <line x1="12" y1="16" x2="12.01" y2="16"></line>
    </svg>
    <p>Impossible de charger les données. Veuillez vous reconnecter.</p>
    <button class="btn-primary" routerLink="/login">Se reconnecter</button>
  </div>

  <!-- Message si aucun besoin -->
  <div *ngIf="!isLoading && currentUserId && besoins.length === 0" class="empty-state">
    <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
      <polyline points="14 2 14 8 20 8"></polyline>
      <line x1="16" y1="13" x2="8" y2="13"></line>
      <line x1="16" y1="17" x2="8" y2="17"></line>
      <polyline points="10 9 9 9 8 9"></polyline>
    </svg>
    <h3>Aucun besoin dans votre service</h3>
    <p>Il n'y a actuellement aucun besoin créé dans votre service.</p>
  </div>

  <!-- Liste des Besoins -->
  <div *ngIf="!isLoading && currentUserId && besoins.length > 0" class="besoins-grid">
    <div 
      *ngFor="let besoin of besoins; let i = index" 
      class="besoin-card"
      [class.fade-in]="fadeIn"
      [style.animation-delay]="i * 100 + 'ms'"
      (click)="openBesoin(besoin)">
      
      <div class="card-header">
        <h3 class="card-title">{{ besoin.titre }}</h3>
        <span [class]="'status-badge ' + getStatutBadgeClass(besoin.statut)">
          {{ getStatutText(besoin.statut) }}
        </span>
      </div>

      <div class="card-info">
        <div class="info-item">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          <span>{{ besoin.employe }} <span *ngIf="besoin.isOwner" class="owner-badge">(Vous)</span></span>
        </div>

        <div class="info-item">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          <span>{{ formatDate(besoin.dateCreation) }}</span>
        </div>

        <div class="info-item">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            <polyline points="7.5 4.21 12 6.81 16.5 4.21"></polyline>
            <polyline points="7.5 19.79 7.5 14.6 3 12"></polyline>
            <polyline points="21 12 16.5 14.6 16.5 19.79"></polyline>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
            <line x1="12" y1="22.08" x2="12" y2="12"></line>
          </svg>
          <span>{{ besoin.service }}</span>
        </div>
      </div>

      <p class="card-description">{{ besoin.description | slice:0:100 }}{{ besoin.description.length > 100 ? '...' : '' }}</p>

      <button class="btn-details">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        Voir les détails
      </button>
    </div>
  </div>

  <!-- Panneau de Détails (Slide-in Panel) -->
  <div *ngIf="selectedBesoin" class="panel-overlay" (click)="closeBesoin()"></div>
  
  <div *ngIf="selectedBesoin" class="detail-panel">
    <!-- Panel Header -->
    <div class="panel-header">
      <h2>Détails du Besoin</h2>
      <button class="btn-close" (click)="closeBesoin()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <!-- Panel Content -->
    <div class="panel-content">
      <!-- Informations du Besoin -->
      <div class="info-card">
        <h3 class="section-title">Informations Générales</h3>
        
        <div class="info-grid">
          <div class="info-field full-width">
            <label>Titre du Besoin</label>
            <p class="value-bold">{{ selectedBesoin.titre }}</p>
          </div>

          <div class="info-field full-width">
            <label>Description</label>
            <p class="description-text">{{ selectedBesoin.description }}</p>
          </div>

          <div class="info-field">
            <label>Créé par</label>
            <p>{{ selectedBesoin.employe }}</p>
          </div>

          <div class="info-field">
            <label>Service</label>
            <p>{{ selectedBesoin.service }}</p>
          </div>

          <div class="info-field">
            <label>Date de création</label>
            <p>{{ formatDate(selectedBesoin.dateCreation) }}</p>
          </div>

          <div class="info-field">
            <label>Statut</label>
            <span [class]="'status-badge ' + getStatutBadgeClass(selectedBesoin.statut)">
              {{ getStatutText(selectedBesoin.statut) }}
            </span>
          </div>

          <div *ngIf="selectedBesoin.statut === 'ACCEPTE' && selectedBesoin.validationDate" class="info-field">
            <label>Date de validation</label>
            <p class="text-success">{{ formatDate(selectedBesoin.validationDate) }}</p>
          </div>

          <div *ngIf="selectedBesoin.statut === 'ACCEPTE' && selectedBesoin.dateValidation" class="info-field">
            <label>Date d'acceptation</label>
            <p class="text-success">{{ formatDate(selectedBesoin.dateValidation) }}</p>
          </div>
        </div>
      </div>

      <!-- Motif de Refus -->
      <div *ngIf="selectedBesoin.statut === 'REFUSE' && selectedBesoin.motifRefus" class="alert-card alert-danger">
        <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <div>
          <h3 class="alert-title">Motif de Refus</h3>
          <p class="alert-text">{{ selectedBesoin.motifRefus }}</p>
        </div>
      </div>

      <!-- Fichier CPS -->
      <div class="cps-viewer">
        <div class="cps-header">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          <h3>Fichier CPS (.txt)</h3>
        </div>
        <div class="cps-content">{{ cpsContent }}</div>
      </div>

      <!-- Actions CAS 1: Besoin de l'utilisateur -->
      <div *ngIf="isOwner">
        <!-- Modifier Besoin -->
        <button *ngIf="showEditButton" class="btn-primary full-width" (click)="modifierBesoin()">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          Modifier mon besoin
        </button>

        <!-- Message si besoin en attente -->
        <div *ngIf="selectedBesoin.statut === 'EN_ATTENTE'" class="info-message">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <p>Votre besoin est en attente de validation par le chef de service.</p>
        </div>
      </div>

<!-- Tâches - Pour TOUS les besoins acceptés -->
<div *ngIf="selectedBesoin.statut === 'ACCEPTE'" class="tasks-section">
  <h3 class="section-title">
    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width: 20px; height: 20px; margin-right: 8px;">
      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
      <polyline points="22 4 12 14.01 9 11.01"></polyline>
    </svg>
    Tâches Validées par le Chef
    <span class="tasks-count">({{ taches.length || 0 }})</span>
  </h3>

  <!-- Message si pas de tâches -->
  <div *ngIf="taches.length === 0" class="info-message">
    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="8" x2="12" y2="12"></line>
      <line x1="12" y1="16" x2="12.01" y2="16"></line>
    </svg>
    <p>Aucune tâche n'a été définie pour ce besoin.</p>
  </div>

  <!-- Liste des tâches -->
  <div *ngFor="let tache of taches" class="task-card task-accepted">
    <div class="task-header">
      <h4>{{ tache.titre }}</h4>
      <span class="task-status status-accepted">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width: 14px; height: 14px; margin-right: 4px;">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        {{ tache.statut === 'ACCEPTEE' ? 'Acceptée' : 'Validée' }}
      </span>
    </div>
    
    <p class="task-description" *ngIf="tache.description">{{ tache.description }}</p>
    
    <div class="task-meta">
      <span *ngIf="tache.dureeEstimee" class="task-duration">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width: 14px; height: 14px; margin-right: 4px;">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        Durée: {{ tache.dureeEstimee }}
      </span>
      
      <span *ngIf="tache.dateFinale" class="task-date">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width: 14px; height: 14px; margin-right: 4px;">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        Date finale: {{ formatDate(tache.dateFinale) }}
      </span>
    </div>
  </div>
</div>

        <!-- Message si pas de tâches -->
        <div *ngIf="selectedBesoin.statut === 'ACCEPTE' && (!taches || taches.length === 0)" class="info-message">
          <p>Aucune tâche n'a été définie pour ce besoin.</p>
        </div>


      <!-- Actions CAS 2: Besoin d'un autre employé -->
      <!-- Remplacer toute la section signal-section par : -->
<div *ngIf="!isOwner && showSignalSection" class="signal-section">
  <div class="signal-header">
    <svg class="icon-warning" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
      <line x1="12" y1="9" x2="12" y2="13"></line>
      <line x1="12" y1="17" x2="12.01" y2="17"></line>
    </svg>
    <h3>Évaluation des Tâches du CPS</h3>
  </div>
  
  <p class="signal-description">
    En tant que membre du même service, vous pouvez évaluer la pertinence des tâches proposées dans le fichier CPS.
    Si vous identifiez des problèmes avec une tâche spécifique, signalez-la au chef de service.
  </p>

  <div class="signal-actions">
    <button class="btn-signal-cps" (click)="openCpsSignalModal()">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
        <line x1="12" y1="9" x2="12" y2="13"></line>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
      Signaler une tâche du CPS
    </button>
  </div>

  <!-- Liste des signalements existants -->
  <div *ngIf="signalements.length > 0" class="signalements-list">
    <h4>Vos signalements précédents</h4>
    <div *ngFor="let signalement of signalements" class="signalement-item">
      <div class="signalement-header">
        <span class="tache-numero">Tâche {{ signalement.numeroTache }}</span>
        <span class="signalement-date">{{ formatDateTime(signalement.dateSignalement) }}</span>
      </div>
      <p class="signalement-message">{{ signalement.message }}</p>
    </div>
  </div>
</div>

      <!-- Message pour besoins refusés ou déjà traités -->
      <div *ngIf="!isOwner && !showSignalSection && selectedBesoin.statut !== 'EN_ATTENTE'" class="info-message">
        <p>
          Ce besoin a déjà été traité par le chef de service 
          <span *ngIf="selectedBesoin.statut === 'ACCEPTE'">et accepté</span>
          <span *ngIf="selectedBesoin.statut === 'REFUSE'">et refusé</span>.
        </p>
      </div>
    </div>
  </div>

  <!-- Modal pour signaler une tâche du CPS -->
<div *ngIf="showCpsSignalModal" class="modal-overlay" (click)="closeCpsSignalModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Signaler une Tâche du CPS</h3>
      <button class="btn-close-modal" (click)="closeCpsSignalModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Numéro de la Tâche *</label>
        <input
          type="text"
          [(ngModel)]="selectedTacheNumero"
          class="form-input"
          placeholder="Ex: Tâche 1, TACHE_2, 3..."
          required>
        <small>Indiquez le numéro/identifiant de la tâche concernée dans le fichier CPS</small>
      </div>

      <div class="form-group">
        <label class="form-label">Votre évaluation *</label>
        <textarea 
          [(ngModel)]="signalMessage"
          class="form-textarea"
          rows="5"
          placeholder="Expliquez pourquoi cette tâche vous semble problématique : 
- Ne répond pas au besoin exprimé
- Est redondante avec d'autres tâches
- N'est pas réalisable dans les délais
- Manque de précision
- Autre raison..."
          required
          maxlength="500"></textarea>
        <div class="character-count">{{ signalMessage.length }}/500 caractères</div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeCpsSignalModal()">Annuler</button>
      <button 
        class="btn-submit" 
        [disabled]="!selectedTacheNumero.trim() || !signalMessage.trim() || signalMessage.length < 10"
        (click)="submitCpsSignal()">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M22 2L11 13"></path>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
        Envoyer au Chef de Service
      </button>
    </div>
  </div>
</div>

  <!-- Modal Modification Besoin -->
<div *ngIf="showEditModal" class="modal-overlay" (click)="closeEditModal()">
  <div class="modal-content large-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Modifier mon besoin</h3>
      <button class="btn-close-modal" (click)="closeEditModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <form (ngSubmit)="submitModification()" #editForm="ngForm">
        <!-- Titre -->
        <div class="form-group">
          <label class="form-label" for="editTitre">Titre du besoin *</label>
          <input
            type="text"
            id="editTitre"
            name="titre"
            [(ngModel)]="editBesoinData.titre"
            class="form-input"
            placeholder="Donnez un titre clair à votre besoin"
            required
            maxlength="255">
          <div class="character-count">{{ editBesoinData.titre.length }}/255 caractères</div>
        </div>

        <!-- Description -->
        <div class="form-group">
          <label class="form-label" for="editDescription">Description détaillée *</label>
          <textarea
            id="editDescription"
            name="description"
            [(ngModel)]="editBesoinData.description"
            class="form-textarea"
            rows="6"
            placeholder="Décrivez en détail votre besoin, les objectifs, les contraintes..."
            required
            maxlength="2000"></textarea>
          <div class="character-count">{{ editBesoinData.description.length }}/2000 caractères</div>
        </div>

        <!-- Fichier CPS -->
        <div class="form-group">
          <label class="form-label">Fichier CPS actuel</label>
          <div class="current-file">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span>{{ selectedBesoin?.fichierCPS || 'Aucun fichier' }}</span>
          </div>
        </div>

        <!-- Nouveau fichier CPS -->
        <div class="form-group">
          <label class="form-label" for="newCpsFile">Changer le fichier CPS (optionnel)</label>
          <div class="file-upload-area" [class.drag-over]="isDragOver" 
               (click)="fileInput.click()"
               (drop)="onFileDrop($event)"
               (dragover)="onDragOver($event)"
               (dragleave)="onDragLeave($event)">
            <input
              #fileInput
              type="file"
              id="newCpsFile"
              (change)="onFileSelected($event)"
              accept=".txt"
              class="file-input"
              hidden>
            
            <div class="upload-content" *ngIf="!newCpsFile">
              <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <p class="upload-text">Cliquez pour sélectionner ou glissez-déposez un fichier .txt</p>
              <p class="upload-subtext">Taille maximale : 5MB</p>
            </div>

            <div class="file-preview" *ngIf="newCpsFile">
              <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
              </svg>
              <div class="file-info">
                <p class="file-name">{{ newCpsFile.name }}</p>
                <p class="file-size">{{ getFileSize(newCpsFile.size) }}</p>
              </div>
              <button type="button" class="btn-remove-file" (click)="removeFile()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Aperçu du contenu du fichier -->
        <div *ngIf="filePreviewContent" class="file-preview-content">
          <h4>Aperçu du fichier :</h4>
          <div class="preview-content">{{ filePreviewContent }}</div>
        </div>

        <!-- Informations importantes -->
        <div class="info-message">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <div>
            <p><strong>Important :</strong> Vous ne pouvez modifier votre besoin que s'il est encore en attente de validation.</p>
            <p>Une fois modifié, le chef de service devra revalider votre besoin.</p>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="closeEditModal()">Annuler</button>
          <button 
            type="submit"
            class="btn-submit" 
            [disabled]="!editForm.valid || isSubmitting">
            <div class="button-content">
              <svg *ngIf="!isSubmitting" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>
              <div *ngIf="isSubmitting" class="spinner-small"></div>
              {{ isSubmitting ? 'Modification en cours...' : 'Modifier le besoin' }}
            </div>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
</div>